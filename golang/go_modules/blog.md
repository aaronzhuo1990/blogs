# How to Convert Go Packages to Go Modules

What is included in this blog:
- A brief introduction of Go modules and Semantic Import Versioning
- A discussion about how to convert Go libraries to Go modules
- A discussion about how to convert Go micro services to Go Modules

## prerequisites

### Go Modules

[Go Modules](https://blog.golang.org/modules2019) is an experimental opt-in feature in Go 1.11 with the plan of finalizing feature for Go 1.13. The definition of a Go module from [this proposal](https://go.googlesource.com/proposal/+/master/design/24301-versioned-go.md) is "a group of packages that share a common prefix, the module path, and are versioned together as a single unit". **A file called `go.mod` glues all the files and packages under the same root directory together as a unit.** Here is an example:

```go
path/to/my-repo:
    bar:
        go.mod
        bar-file1.go
        bar-file2.go
        foo:
            foo-file1.go
            foo-file2.go
    mixi:
        go.mod
        mixi-file1.go
        mixi-file2.go
```

[image]

As shown in the picture above, it has two modules `bar` and `mixi`. The module `bar` includes two packages: the package `bar` and the package `foo`.

**The `go.mod` under the `path/to/my-repo/bar` directory glues these two packages together as a single unit.** It defines the module's path and its dependencies:

```go
module path/to/my-repo/bar

require (
	golang.org/x/text v0.3.0
	rsc.io/sampler v1.99.99
	// Other dependencies
)
```

Now the package `bar` and `foo` are bundled together as a unit. For example, the import statement imports the module `path/to/my-repo/bar` other than the package `path/to/my-repo/bar/foo` if Go Modules is enabled. **This means the path in the import statement is considered the module path, not the import path (package path).**

```go
import "path/to/my-repo/bar/foo"

func main () {
    foo.DoSomething()
}
```

In order to use Go Modules, you need to upgrade your Go to v1.11 and set the environmental variable `GO111MODULE=on`.


### Semantic Import Versioning

[Semantic Import Versioning](https://research.swtch.com/vgo-import) is a method proposed for adopting [Semantic Versioning](https://semver.org/) in Go packages or modules. The idea behind it is to embedding major version (say `v2`) in the import path (for packages) or the module path (for modules) with the following rules:

- `v1` must be omitted from the import path or the module path. [This post](https://github.com/golang/go/issues/24301#issuecomment-371228664) explains the reason.
- Major versions higher than `v1` must be embedded in the import path or the module path so that Semantic Versioning can be adopted in Go packages or Go Modules.

The following picture demonstrates the rules above:

[image]

#### Releasing

With Go Modules and Semantic Import Versioning, you can release your modules by creating git tags, for example:

```go
git tag bar/v2.3.3 && git push -q origin master bar/v2.3.3
```

**The tag MUST follow the format {pure_module_path}/v{Major}.{Minor}.{Patch} and {pure_module_path} means the module path without repo URL (which is `bar` in this case). The is key point that makes Go able to retrieve Go modules.**

I recommend you reading [this proposal]((https://research.swtch.com/vgo-import)) or [this blog]() if you want to know more details about Semantic Import Versioning.


All in all, Go Modules provides a way to group one or more packages as a single retrievable unit, while Semantic Import Versioning proposes a method for adopting Semantic Import in Go packages and go Modules. There two things are the foundation of "versioned Go modules".

## Converting Go Packages to Go Modules

### General Guide

I wrote [a dummy package](https://github.com/aaronzhuo1990/blogs/tree/master/golang/go_modules/example/module) called `module` for the purpose of demonstrating how to convert Go package(s) to a Go module.

#### Converting Go Package(s) to A Go Module

It is very easy to convert Go package(s) to a Go module. Take the package `module` as example, here are the steps to convert it to a Go module:

```go
1. Cd to the root directory of the `module` package: `cd path/to/module`
2. Convert the package to a module: `go mod init github.com/aaronzhuo1990/blogs/golang/go_modules/example/module`
3. Compile the module and its dependencies: `go build`
4. Commit the changes: `git add ./go.mod ./go.sum git commit -q  -m -a "Convert the package to a module" && git push origin master -q`
```

Here is the `go.mod` file generated by the steps above:

```go
module github.com/aaronzhuo1990/blogs/golang/go_modules/example/module

go 1.12

require (
	golang.org/x/net v0.0.0-20190328230028-74de082e2cca
	rsc.io/quote v1.5.2
)
```

#### Releasing

A module can only be used when it is released. The module is released by creating git tags, each tag corresponds to a version. However, there are two problems we need to solve in order to release a module.

The first problem is how to release `v2` or higher Major version. Go adopts two methods provided by [this proposal](https://research.swtch.com/vgo-module#from_repository_to_modules) to solve this problem: Major Branch and Major Subdirectory. [This blog] demonstrates these two methods and compare their advantage and disadvantage. In this example, I decide to choose Major Subdirectory as it does not require me to duplicate any code.

The second problem is we need to figure out whether converting Go package(s) to Go modules is a breaking change. If so, we need to upgrade the Major version based the specification of [Semantic Versioning](https://semver.org/). If not, we need to decide what versions we need to release. I prefer to just release the latest version listed in the `CHANGELOG.md` file for the following reasons:

- Converting Go package(s) to Go modules is not a breaking change as the package(s) can still work with Go without Go Modules enabled. So upgrading the Major version for this change is not proper.
- Converting Go package(s) to Go modules does not add any new feature or fix ant bug. So upgrading the Minor or Patch version does not make sense either.


Let us come back to the example and release it. Here are what we need to do:
- Append `v2` to the end of the module path (module `github.com/aaronzhuo1990/blogs/golang/go_modules/example/module/v2`) as the latest version of this package (module) is `v2.0.1`
- Put a note under the `v2.0.1` release note in the `CHANGELOG.md` file to indicate that the package is converted to a module.
- Release `v2.0.1`: `git tag golang/go_modules/example/module/v2.0.1 && git push -q origin master golang/go_modules/example/module/v2.0.1`

Now without Go Modules, you can still get this package using some Go dependency management tool, for example dep, with following specification in the `go.toml` file:

```go
[[constraint]]
  name = "github.com/aaronzhuo1990/blogs"
  branch = "master"
```

With Go Modules, what you need to do is import/use the module in your Go program and run `go build`. It will automatically grab `golang/go_modules/example/module/v2.0.1` for you.


## Converting Go Libraries to Go Modules

The section above already demonstrates how to convert one or more Go packages to a Go module. This section is talking about how to convert all the Go packages (libraries) within a single repository to Go modules.


Convert libc first

```go
go mod init github.com/aaronzhuo1990/blogs/golang/go_modules/example/libs/libc
go: creating new go.mod: module github.com/aaronzhuo1990/blogs/golang/go_modules/example/libs/libc
go build:

can't load package: package github.com/aaronzhuo1990/blogs/golang/go_modules/example/libs/libc: unknown import path "github.com/aaronzhuo1990/blogs/golang/go_modules/example/libs/libc": ambiguous import: found github.com/aaronzhuo1990/blogs/golang/go_modules/example/libs/libc in multiple modules:
        github.com/aaronzhuo1990/blogs/golang/go_modules/example/libs/libc (/Users/achuo/go/src/github.com/aaronzhuo1990/blogs/golang/go_modules/example/libs/libc)
        github.com/aaronzhuo1990/blogs v0.0.0-20190330175117-09a7dbd4a3ce (/Users/achuo/go/pkg/mod/github.com/aaronzhuo1990/blogs@v0.0.0-20190330175117-09a7dbd4a3ce/golang/go_modules/example/libs/libc)

```

Problem:
    v0.0.0-20190330175117-09a7dbd4a3ce is the latest commit of the `github.com/aaronzhuo1990/blogs` repository, in includes `liba`, `libb` and `libb`

Solution:
    Convert



Convert liba:

```go
azhuo:liba achuo$ go mod init github.com/aaronzhuo1990/blogs/golang/go_modules/example/libs/liba
go: creating new go.mod: module github.com/aaronzhuo1990/blogs/golang/go_modules/example/libs/liba
azhuo:liba achuo$ go build
go: finding golang.org/x/net/context latest
go: finding golang.org/x/net latest

# Commit changes

git add ./go.mod ./go.sum
git commit ./go.mod ./go.sum -q -m "Convert liba  to a module" && git push origin master -q

# Release the latest version (v1.1.0):

git tag golang/go_modules/example/libs/liba/v1.1.0 && git push -q origin master golang/go_modules/example/libs/liba/v1.1.0
```

convert libb:

```

azhuo:libb achuo$ go mod init github.com/aaronzhuo1990/blogs/golang/go_modules/example/libs/libb
go: creating new go.mod: module github.com/aaronzhuo1990/blogs/golang/go_modules/example/libs/libb
azhuo:libb achuo$ go build
go: finding github.com/aaronzhuo1990/blogs/golang/go_modules/example/libs/liba v1.1.0
go: finding golang.org/x/net/context latest
go: finding golang.org/x/net latest
go: downloading github.com/aaronzhuo1990/blogs/golang/go_modules/example/libs/liba v1.1.0
go: extracting github.com/aaronzhuo1990/blogs/golang/go_modules/example/libs/liba v1.1.0
go: finding golang.org/x/text v0.3.0
go: finding golang.org/x/crypto v0.0.0-20190308221718-c2843e01d9a2
go: finding rsc.io/quote v1.5.2
go: finding rsc.io/sampler v1.3.0
go: finding golang.org/x/text v0.0.0-20170915032832-14c0d48ead0c
go: finding golang.org/x/sys v0.0.0-20190215142949-d0b11bdaac8a


azhuo:libb achuo$ git add ./go.mod ./go.sum
azhuo:libb achuo$ git commit ./go.mod ./go.sum -q -m "Convert libb  to a module" && git push origin master -q
azhuo:libb achuo$ git tag golang/go_modules/example/libs/libb/v1.0.0 && git push -q origin master golang/go_modules/example/libs/libb/v1.0.0


```

Convert libc

```
go mod init github.com/aaronzhuo1990/blogs/golang/go_modules/example/libs/libc
go build


azhuo:libc achuo$ git add ./go.mod ./go.sum
azhuo:libc achuo$ git commit ./go.mod ./go.sum -q -m "Convert libc  to a module" && git push origin master -q
azhuo:libc achuo$ git tag golang/go_modules/example/libs/libc/v1.0.0 && git push -q origin master golang/go_modules/example/libs/libc/v1.0.0


```




## Converting Go Micro Services

